name: Security Review Trigger

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - labeled

jobs:
  trigger-review:
    name: Trigger Security Review
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      github.event.pull_request.base.ref == 'main'
    permissions:
      contents: read
    steps:
      - name: Parse reviewer repository
        id: parse-repo
        env:
          REVIEWER_REPOSITORY: ${{ secrets.REVIEWER_REPOSITORY }}
        run: |
          set -euo pipefail
          if [ -z "${REVIEWER_REPOSITORY:-}" ]; then
            echo "REVIEWER_REPOSITORY secret is required" >&2
            exit 1
          fi
          echo "name=${REVIEWER_REPOSITORY#*/}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.MCP_REGISTRY_BOT_APP_ID }}
          private-key: ${{ secrets.MCP_REGISTRY_BOT_PRIVATE_KEY }}
          owner: docker
          repositories: ${{ steps.parse-repo.outputs.name }}

      - name: Dispatch private workflow
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          REVIEWER_REPOSITORY: ${{ secrets.REVIEWER_REPOSITORY }}
        run: |
          set -euo pipefail

          pr_number="${{ github.event.pull_request.number }}"
          payload=$(jq -n \
            --arg pr "$pr_number" \
            --arg agent "claude" \
            --arg model "" \
            --arg timeout "" \
            --arg force "false" \
            --arg source_repo "${{ github.repository }}" \
            '{pull_request_number:$pr, agent:$agent, model:$model, timeout_secs:$timeout, force_review:$force, repository:$source_repo}'
          )

          curl -sSf -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${REVIEWER_REPOSITORY}/dispatches" \
            -d "{\"event_type\":\"security-review\",\"client_payload\":${payload}}"

          echo "Dispatched automated review for PR #$pr_number"
