name: Security Review (Manual)

on:
  workflow_dispatch:
    inputs:
      servers:
        description: "Comma-separated list of local server names to audit (leave blank for all)."
        required: false
        default: ""
      agent:
        description: "Reviewer agent"
        required: false
        type: choice
        options:
          - claude
          - codex
        default: claude
      model:
        description: "Optional reviewer model override."
        required: false
        default: ""
      timeout_secs:
        description: "Optional reviewer timeout in seconds (defaults to 1800)."
        required: false
        default: ""

concurrency:
  group: security-review-manual-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  dispatch:
    name: Dispatch Manual Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger private workflow
        env:
          GH_TOKEN: ${{ secrets.SECURITY_REVIEW_APP_TOKEN }}
          REVIEWER_REPOSITORY: ${{ secrets.REVIEWER_REPOSITORY }}
        run: |
          set -euo pipefail

          if [ -z "${GH_TOKEN:-}" ]; then
            echo "SECURITY_REVIEW_APP_TOKEN secret is required" >&2
            exit 1
          fi
          if [ -z "${REVIEWER_REPOSITORY:-}" ]; then
            echo "REVIEWER_REPOSITORY secret is required" >&2
            exit 1
          fi

          payload=$(jq -n \
            --arg servers "${{ github.event.inputs.servers }}" \
            --arg agent "${{ github.event.inputs.agent || 'claude' }}" \
            --arg model "${{ github.event.inputs.model }}" \
            --arg timeout "${{ github.event.inputs.timeout_secs }}" \
            '{servers:$servers, agent:$agent, model:$model, timeout_secs:$timeout}'
          )

          curl -sSf -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${REVIEWER_REPOSITORY}/dispatches" \
            -d "{\"event_type\":\"security-review-manual\",\"client_payload\":${payload}}"

          echo "Dispatched manual security review"
